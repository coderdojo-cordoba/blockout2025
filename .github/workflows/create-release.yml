name: Create Release

on:
  workflow_dispatch:
    branches:
      - main
      - development
    inputs:
      version:
        description: 'Release version (e.g., v2.5.0)'
        required: true
        default: 'v2.5.0'

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:

  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge development into main (if on development)
      if: github.ref == 'refs/heads/development'
      run: |
        git checkout main
        git pull origin main
        git merge origin/development -m "Release ${{ github.event.inputs.version }}: Merge development into main"
        git push origin main

    - name: Create Release Tag
      run: |
        git tag -a ${{ github.event.inputs.version }} -m "Release ${{ github.event.inputs.version }}"
        git push origin ${{ github.event.inputs.version }}


    - name: Wait for platform builds to complete
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Waiting for platform build workflows to complete..."
        echo "Tag created: ${{ github.event.inputs.version }}"
        
        # Give workflows time to start (tag push triggers them)
        sleep 30
        
        # List of workflows to wait for
        workflows=(
          "Build Linux Tarball"
          "Build Windows"
          "Build macOS (brew)"
          "Build Debian Packages (Ubuntu releases)"
          "Build RPM (Fedora)"
          "Build Arch Package"
        )
        
        max_wait=1800  # 30 minutes
        check_interval=30
        elapsed=0
        
        while [ $elapsed -lt $max_wait ]; do
          all_complete=true
          
          echo ""
          echo "Checking workflow status (${elapsed}s elapsed)..."
          
          for workflow in "${workflows[@]}"; do
            # Get the latest run for this workflow on main branch
            run_status=$(gh run list \
              --workflow "$workflow" \
              --branch main \
              --limit 1 \
              --json status,conclusion \
              --jq '.[0] | "\(.status):\(.conclusion)"')
            
            status=$(echo "$run_status" | cut -d: -f1)
            conclusion=$(echo "$run_status" | cut -d: -f2)
            
            echo "  $workflow: $status ($conclusion)"
            
            if [ "$status" != "completed" ]; then
              all_complete=false
            elif [ "$conclusion" = "failure" ]; then
              echo "WARNING: $workflow failed!"
            fi
          done
          
          if [ "$all_complete" = true ]; then
            echo ""
            echo "All workflows completed!"
            break
          fi
          
          sleep $check_interval
          elapsed=$((elapsed + check_interval))
        done
        
        if [ $elapsed -ge $max_wait ]; then
          echo "WARNING: Timeout waiting for workflows. Proceeding anyway..."
        fi

        echo ""
        echo "Downloading artifacts..."
        mkdir -p release-artifacts
        for workflow in "${workflows[@]}"; do
          echo "Downloading artifacts for $workflow..."
          # Get run ID
          run_id=$(gh run list --workflow "$workflow" --branch main --limit 1 --json databaseId --jq '.[0].databaseId')
          if [ -n "$run_id" ]; then
            gh run download "$run_id" --dir release-artifacts || echo "WARNING: Failed to download artifacts for $workflow"
          else
            echo "WARNING: No run found for $workflow"
          fi
        done


    - name: List downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        ls -lah release-artifacts/ || echo "No artifacts found in release-artifacts/"
        ls -lah . | grep blockout || echo "No artifacts found in current directory"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: BlockOut II ${{ github.event.inputs.version }}
        body: |
          # BlockOut II ${{ github.event.inputs.version }}
          
          ## Downloads
          
          Choose the package for your platform:
          
          - **Linux (Generic)**: `blockout-linux-x64-*.tar.gz` - Extract and run `./blockout/blockout`
          - **Windows**: `blockout-windows-*.zip` - Extract and run `Blockout.exe`
          - **macOS (Homebrew)**: `blockout-macos-*.tar.gz` - Extract and run the binary
          - **Ubuntu/Debian**: `blockout-*-ubuntu*.deb` - Install with `sudo dpkg -i blockout-*.deb`
          - **Fedora/RHEL**: `blockout-*.rpm` - Install with `sudo dnf install blockout-*.rpm`
          - **Arch Linux**: `blockout-*.pkg.tar.zst` - Install with `sudo pacman -U blockout-*.pkg.tar.zst`
          
          ## Changes
          
          This release includes:
          - Internationalization support for 23 languages
          - Comprehensive contributor documentation (CONTRIBUTING.md)
          - Multi-language README files
          - Fixed all platform build issues (Windows, macOS, Fedora, Arch Linux, Ubuntu/Debian)
          - macOS: Built with sdl12-compat and SDL_mixer 1.2 from source
          - Windows: Packaged with all required DLLs and assets
          - Linux: Generic x64 tarball for any distribution
          - Ubuntu/Debian: Packages for Ubuntu 24.04, 25.04, and 25.10
          - All platforms: Automated release packaging
          
          See the full changelog in the repository.
        draft: false
        prerelease: false
        files: |
          release-artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
